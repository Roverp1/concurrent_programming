<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Room</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400;500;600&family=Noto+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Material Design 3 Dark Theme Colors (from dark.css) */
      :root {
        --md-sys-color-primary: rgb(241 190 109);
        --md-sys-color-surface-tint: rgb(241 190 109);
        --md-sys-color-on-primary: rgb(67 44 0);
        --md-sys-color-primary-container: rgb(96 65 0);
        --md-sys-color-on-primary-container: rgb(255 222 173);
        --md-sys-color-secondary: rgb(219 195 161);
        --md-sys-color-on-secondary: rgb(61 46 22);
        --md-sys-color-secondary-container: rgb(85 68 42);
        --md-sys-color-on-secondary-container: rgb(249 223 187);
        --md-sys-color-tertiary: rgb(181 206 164);
        --md-sys-color-on-tertiary: rgb(34 53 24);
        --md-sys-color-tertiary-container: rgb(56 76 44);
        --md-sys-color-on-tertiary-container: rgb(209 234 190);
        --md-sys-color-error: rgb(255 180 171);
        --md-sys-color-on-error: rgb(105 0 5);
        --md-sys-color-error-container: rgb(147 0 10);
        --md-sys-color-on-error-container: rgb(255 218 214);
        --md-sys-color-background: rgb(24 19 11);
        --md-sys-color-on-background: rgb(236 225 212);
        --md-sys-color-surface: rgb(24 19 11);
        --md-sys-color-on-surface: rgb(236 225 212);
        --md-sys-color-surface-variant: rgb(78 69 57);
        --md-sys-color-on-surface-variant: rgb(210 196 180);
        --md-sys-color-outline: rgb(155 143 128);
        --md-sys-color-outline-variant: rgb(78 69 57);
        --md-sys-color-shadow: rgb(0 0 0);
        --md-sys-color-scrim: rgb(0 0 0);
        --md-sys-color-inverse-surface: rgb(236 225 212);
        --md-sys-color-inverse-on-surface: rgb(54 47 39);
        --md-sys-color-inverse-primary: rgb(125 87 14);
        --md-sys-color-primary-fixed: rgb(255 222 173);
        --md-sys-color-on-primary-fixed: rgb(40 25 0);
        --md-sys-color-primary-fixed-dim: rgb(241 190 109);
        --md-sys-color-on-primary-fixed-variant: rgb(96 65 0);
        --md-sys-color-secondary-fixed: rgb(249 223 187);
        --md-sys-color-on-secondary-fixed: rgb(38 25 4);
        --md-sys-color-secondary-fixed-dim: rgb(219 195 161);
        --md-sys-color-on-secondary-fixed-variant: rgb(85 68 42);
        --md-sys-color-tertiary-fixed: rgb(209 234 190);
        --md-sys-color-on-tertiary-fixed: rgb(13 32 5);
        --md-sys-color-tertiary-fixed-dim: rgb(181 206 164);
        --md-sys-color-on-tertiary-fixed-variant: rgb(56 76 44);
        --md-sys-color-surface-dim: rgb(24 19 11);
        --md-sys-color-surface-bright: rgb(63 56 47);
        --md-sys-color-surface-container-lowest: rgb(18 13 7);
        --md-sys-color-surface-container-low: rgb(32 27 19);
        --md-sys-color-surface-container: rgb(36 31 23);
        --md-sys-color-surface-container-high: rgb(47 41 33);
        --md-sys-color-surface-container-highest: rgb(58 52 43);

        /* Material Design 3 Type Scale Tokens */
        /* Display (Kode Mono for headlines/titles) */
        --md-sys-typescale-display-large-font: "Kode Mono", monospace;
        --md-sys-typescale-display-large-size: 57px;
        --md-sys-typescale-display-large-line-height: 64px;
        --md-sys-typescale-display-large-weight: 400;

        --md-sys-typescale-headline-large-font: "Kode Mono", monospace;
        --md-sys-typescale-headline-large-size: 32px;
        --md-sys-typescale-headline-large-line-height: 40px;
        --md-sys-typescale-headline-large-weight: 400;

        --md-sys-typescale-headline-medium-font: "Kode Mono", monospace;
        --md-sys-typescale-headline-medium-size: 28px;
        --md-sys-typescale-headline-medium-line-height: 36px;
        --md-sys-typescale-headline-medium-weight: 400;

        --md-sys-typescale-headline-small-font: "Kode Mono", monospace;
        --md-sys-typescale-headline-small-size: 24px;
        --md-sys-typescale-headline-small-line-height: 32px;
        --md-sys-typescale-headline-small-weight: 400;

        /* Title  */
        --md-sys-typescale-title-large-font: "Kode Mono", monospace;
        --md-sys-typescale-title-large-size: 22px;
        --md-sys-typescale-title-large-line-height: 28px;
        --md-sys-typescale-title-large-weight: 400;

        --md-sys-typescale-title-medium-font: "Kode Mono", monospace;
        --md-sys-typescale-title-medium-size: 16px;
        --md-sys-typescale-title-medium-line-height: 24px;
        --md-sys-typescale-title-medium-weight: 500;

        --md-sys-typescale-title-small-font: "Kode Mono", monospace;
        --md-sys-typescale-title-small-size: 14px;
        --md-sys-typescale-title-small-line-height: 20px;
        --md-sys-typescale-title-small-weight: 500;

        /* Label (Noto Sans) */
        --md-sys-typescale-label-large-font: "Noto Sans", sans-serif;
        --md-sys-typescale-label-large-size: 14px;
        --md-sys-typescale-label-large-line-height: 20px;
        --md-sys-typescale-label-large-weight: 500;

        --md-sys-typescale-label-medium-font: "Noto Sans", sans-serif;
        --md-sys-typescale-label-medium-size: 12px;
        --md-sys-typescale-label-medium-line-height: 16px;
        --md-sys-typescale-label-medium-weight: 500;

        --md-sys-typescale-label-small-font: "Noto Sans", sans-serif;
        --md-sys-typescale-label-small-size: 11px;
        --md-sys-typescale-label-small-line-height: 16px;
        --md-sys-typescale-label-small-weight: 500;

        /* Body (Noto Sans) */
        --md-sys-typescale-body-large-font: "Noto Sans", sans-serif;
        --md-sys-typescale-body-large-size: 16px;
        --md-sys-typescale-body-large-line-height: 24px;
        --md-sys-typescale-body-large-weight: 400;

        --md-sys-typescale-body-medium-font: "Noto Sans", sans-serif;
        --md-sys-typescale-body-medium-size: 14px;
        --md-sys-typescale-body-medium-line-height: 20px;
        --md-sys-typescale-body-medium-weight: 400;

        --md-sys-typescale-body-small-font: "Noto Sans", sans-serif;
        --md-sys-typescale-body-small-size: 12px;
        --md-sys-typescale-body-small-line-height: 16px;
        --md-sys-typescale-body-small-weight: 400;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--md-sys-typescale-body-medium-font);
        font-size: var(--md-sys-typescale-body-medium-size);
        line-height: var(--md-sys-typescale-body-medium-line-height);
        font-weight: var(--md-sys-typescale-body-medium-weight);
        background: var(--md-sys-color-background);
        color: var(--md-sys-color-on-surface);
      }

      /* Container */
      .container {
        max-width: 900px;
        margin: 0 auto;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--md-sys-color-surface);
      }

      /* Header */
      .header {
        background: var(--md-sys-color-surface-container);
        border-bottom: 1px solid var(--md-sys-color-outline-variant);
        padding: 16px 24px;
      }

      .header h1 {
        font-family: var(--md-sys-typescale-headline-small-font);
        font-size: var(--md-sys-typescale-headline-small-size);
        line-height: var(--md-sys-typescale-headline-small-line-height);
        font-weight: var(--md-sys-typescale-headline-small-weight);
        color: var(--md-sys-color-on-surface);
        margin-bottom: 8px;
      }

      .stats {
        display: flex;
        gap: 24px;
        font-family: var(--md-sys-typescale-body-small-font);
        font-size: var(--md-sys-typescale-body-small-size);
        line-height: var(--md-sys-typescale-body-small-line-height);
        font-weight: var(--md-sys-typescale-body-small-weight);
        color: var(--md-sys-color-on-surface-variant);
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .stat-value {
        font-weight: 500;
        color: var(--md-sys-color-primary);
      }

      /* Status bar */
      .status {
        padding: 8px 24px;
        font-family: var(--md-sys-typescale-label-medium-font);
        font-size: var(--md-sys-typescale-label-medium-size);
        line-height: var(--md-sys-typescale-label-medium-line-height);
        font-weight: var(--md-sys-typescale-label-medium-weight);
        text-align: center;
        background: var(--md-sys-color-tertiary-container);
        color: var(--md-sys-color-on-tertiary-container);
      }

      .status.disconnected {
        background: var(--md-sys-color-error-container);
        color: var(--md-sys-color-on-error-container);
      }

      /* Messages area */
      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px 24px;
        background: var(--md-sys-color-surface-dim);
      }

      .message {
        background: var(--md-sys-color-surface-container);
        border: 1px solid var(--md-sys-color-outline-variant);
        border-radius: 4px;
        padding: 12px 16px;
        margin-bottom: 12px;
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 6px;
      }

      .username {
        font-family: var(--md-sys-typescale-title-small-font);
        font-size: var(--md-sys-typescale-title-small-size);
        line-height: var(--md-sys-typescale-title-small-line-height);
        font-weight: var(--md-sys-typescale-title-small-weight);
        color: var(--md-sys-color-primary);
      }

      .timestamp {
        font-family: var(--md-sys-typescale-label-small-font);
        font-size: var(--md-sys-typescale-label-small-size);
        line-height: var(--md-sys-typescale-label-small-line-height);
        font-weight: var(--md-sys-typescale-label-small-weight);
        color: var(--md-sys-color-on-surface-variant);
      }

      .message-content {
        font-family: var(--md-sys-typescale-body-medium-font);
        font-size: var(--md-sys-typescale-body-medium-size);
        line-height: var(--md-sys-typescale-body-medium-line-height);
        font-weight: var(--md-sys-typescale-body-medium-weight);
        color: var(--md-sys-color-on-surface);
        word-wrap: break-word;
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        color: var(--md-sys-color-on-surface-variant);
        padding: 48px 24px;
        font-family: var(--md-sys-typescale-body-medium-font);
        font-size: var(--md-sys-typescale-body-medium-size);
        line-height: var(--md-sys-typescale-body-medium-line-height);
      }

      /* Input area */
      .input-area {
        padding: 16px 24px;
        background: var(--md-sys-color-surface-container);
        border-top: 1px solid var(--md-sys-color-outline-variant);
      }

      .input-group {
        margin-bottom: 12px;
      }

      label {
        display: block;
        font-family: var(--md-sys-typescale-label-medium-font);
        font-size: var(--md-sys-typescale-label-medium-size);
        line-height: var(--md-sys-typescale-label-medium-line-height);
        font-weight: var(--md-sys-typescale-label-medium-weight);
        color: var(--md-sys-color-on-surface-variant);
        margin-bottom: 4px;
      }

      input[type="text"],
      textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--md-sys-color-outline);
        border-radius: 4px;
        font-family: var(--md-sys-typescale-body-large-font);
        font-size: var(--md-sys-typescale-body-large-size);
        line-height: var(--md-sys-typescale-body-large-line-height);
        font-weight: var(--md-sys-typescale-body-large-weight);
        background: var(--md-sys-color-surface-container-high);
        color: var(--md-sys-color-on-surface);
        transition: border-color 0.2s;
      }

      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: var(--md-sys-color-primary);
        border-width: 2px;
        padding: 11px 15px;
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      /* Button */
      button {
        width: 100%;
        padding: 10px 24px;
        background: var(--md-sys-color-primary);
        color: var(--md-sys-color-on-primary);
        border: none;
        border-radius: 4px;
        font-family: var(--md-sys-typescale-label-large-font);
        font-size: var(--md-sys-typescale-label-large-size);
        line-height: var(--md-sys-typescale-label-large-line-height);
        font-weight: var(--md-sys-typescale-label-large-weight);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition:
          background 0.2s,
          box-shadow 0.2s;
      }

      button:hover {
        background: var(--md-sys-color-primary-fixed-dim);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      button:active {
        background: var(--md-sys-color-primary-container);
      }

      button:disabled {
        background: var(--md-sys-color-surface-variant);
        color: var(--md-sys-color-on-surface-variant);
        cursor: not-allowed;
      }

      /* Scrollbar */
      .messages::-webkit-scrollbar {
        width: 12px;
      }

      .messages::-webkit-scrollbar-track {
        background: var(--md-sys-color-surface);
      }

      .messages::-webkit-scrollbar-thumb {
        background: var(--md-sys-color-outline-variant);
        border-radius: 6px;
      }

      .messages::-webkit-scrollbar-thumb:hover {
        background: var(--md-sys-color-outline);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          height: 100vh;
        }

        .header {
          padding: 12px 16px;
        }

        .messages {
          padding: 12px 16px;
        }

        .input-area {
          padding: 12px 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>Chat Room</h1>
        <div class="stats">
          <div class="stat-item">
            <span>Online:</span>
            <span class="stat-value" id="activeClients">0</span>
          </div>
          <div class="stat-item">
            <span>Messages:</span>
            <span class="stat-value" id="totalMessages">0</span>
          </div>
        </div>
      </div>

      <!-- Connection status -->
      <div class="status" id="status">Connected</div>

      <!-- Messages area -->
      <div class="messages" id="messages">
        <div class="empty-state">No messages yet. Start the conversation!</div>
      </div>

      <!-- Input area -->
      <div class="input-area">
        <div class="input-group">
          <label for="username">Name (optional)</label>
          <input
            type="text"
            id="username"
            placeholder="Anonymous"
            maxlength="30"
          />
        </div>
        <div class="input-group">
          <label for="message">Message</label>
          <textarea
            id="message"
            placeholder="Type your message..."
            maxlength="500"
          ></textarea>
        </div>
        <button onclick="sendMessage()" id="sendBtn">Send</button>
      </div>
    </div>

    <script>
      // DOM elements
      const messagesDiv = document.getElementById("messages");
      const usernameInput = document.getElementById("username");
      const messageInput = document.getElementById("message");
      const sendBtn = document.getElementById("sendBtn");
      const statusDiv = document.getElementById("status");
      const activeClientsSpan = document.getElementById("activeClients");
      const totalMessagesSpan = document.getElementById("totalMessages");

      let eventSource;

      // Connect to server event stream
      function connect() {
        eventSource = new EventSource("/stream");

        eventSource.onopen = function () {
          console.log("Connected to server");
          statusDiv.textContent = "Connected";
          statusDiv.className = "status";
        };

        eventSource.onmessage = function (event) {
          const message = JSON.parse(event.data);
          displayMessage(message);
        };

        eventSource.onerror = function (error) {
          console.error("Connection error:", error);
          statusDiv.textContent = "Disconnected - Reconnecting...";
          statusDiv.className = "status disconnected";
          eventSource.close();
          setTimeout(connect, 3000);
        };
      }

      // Display message in chat
      function displayMessage(message) {
        const emptyState = messagesDiv.querySelector(".empty-state");
        if (emptyState) {
          emptyState.remove();
        }

        const messageEl = document.createElement("div");
        messageEl.className = "message";

        const timestamp = new Date(message.timestamp).toLocaleTimeString(
          "en-US",
          {
            hour: "2-digit",
            minute: "2-digit",
          },
        );

        messageEl.innerHTML = `
                <div class="message-header">
                    <span class="username">${escapeHtml(message.username)}</span>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
            `;

        messagesDiv.appendChild(messageEl);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Send message
      async function sendMessage() {
        const username = usernameInput.value.trim() || "Anonymous";
        const content = messageInput.value.trim();

        if (!content) {
          alert("Please enter a message");
          return;
        }

        sendBtn.disabled = true;
        sendBtn.textContent = "Sending...";

        try {
          const response = await fetch("/post", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              content: content,
            }),
          });

          if (response.ok) {
            messageInput.value = "";
            messageInput.focus();
          } else {
            alert("Failed to send message");
          }
        } catch (error) {
          console.error("Error sending message:", error);
          alert("Error sending message");
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = "Send";
        }
      }

      // Update stats
      async function updateStats() {
        try {
          const response = await fetch("/stats");
          const stats = await response.json();
          activeClientsSpan.textContent = stats.active_clients;
          totalMessagesSpan.textContent = stats.total_messages;
        } catch (error) {
          console.error("Error fetching stats:", error);
        }
      }

      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Enter to send
      messageInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Initialize
      connect();
      updateStats();
      setInterval(updateStats, 3000);
      messageInput.focus();
    </script>
  </body>
</html>
